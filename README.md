# tdx2db - é€šè¾¾ä¿¡æ•°æ®å¯¼å…¥åˆ° DuckDB

## æ¦‚è¿°

`tdx2db` æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ã€‚

ç”¨äºå°†é€šè¾¾ä¿¡æ•°æ®å¯¼å…¥å¹¶æ›´æ–°è‡³ DuckDB æ•°æ®åº“ï¼Œæ”¯æŒè‚¡ç¥¨å†å²æ•°æ®çš„å…¨é‡åˆå§‹åŒ–å’Œå¢é‡æ›´æ–°ã€‚

ä½¿ç”¨ DuckDB ä¸­æ•°æ®çš„ä»£ç ç¤ºä¾‹è§: [quant-base](https://github.com/jing2uo/quant-base)

## åŠŸèƒ½ç‰¹æ€§

- **å¿«é€Ÿè¿è¡Œ**ï¼šGo å¹¶å‘å¤„ç†ï¼Œå…¨é‡å¯¼å…¥ä¸åˆ° 6sï¼ˆUltra 5 228V + 32G ä¾›å‚è€ƒï¼‰
- **å¢é‡æ›´æ–°**ï¼šæ”¯æŒæ¯å¤©æˆ–éš”å‡ å¤©å¢é‡æ›´æ–°æ•°æ®
- **å¤æƒè®¡ç®—**ï¼šè§†å›¾ v_qfq_stocks å­˜æ”¾äº†å‰å¤æƒè¡Œæƒ…æ•°æ®ï¼Œè‡ªåŠ¨æ›´æ–°
- **ä½¿ç”¨é€šè¾¾ä¿¡åˆ¸å•†æ•°æ®**ï¼šæ”¶ç›˜åæ›´æ–°ï¼Œä¸ç”¨é¢‘ç¹å‘èµ· api è¯·æ±‚ï¼Œç¨³å®šå¯é 
- **å•æ–‡ä»¶æ— ä¾èµ–**ï¼šæ‰“åŒ…é€šè¾¾ä¿¡æ•°æ®å¤„ç†å·¥å…· datatool åœ¨ç¨‹åºå†…éƒ¨æ‰§è¡Œ

## å®‰è£…è¯´æ˜

### ä½¿ç”¨ Docker æˆ– podman

é¡¹ç›®ä¼šåˆ©ç”¨ github action æ„å»ºå®¹å™¨é•œåƒï¼Œwindows å’Œ mac å¯ä»¥é€šè¿‡ docker æˆ– podman ä½¿ç”¨:

```bash
docker run --rm --platform=linux/amd64 ghcr.io/jing2uo/tdx2db:latest -h
```

### Linux äºŒè¿›åˆ¶å®‰è£…

ä» [releases](https://github.com/jing2uo/tdx2db/releases) ä¸‹è½½å¯¹åº”ç³»ç»Ÿçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè§£å‹åç§»è‡³ `$PATH`ï¼š

```bash
sudo mv tdx2db /usr/local/bin/
tdx2db -h # éªŒè¯å®‰è£…
```

## ä½¿ç”¨æ–¹æ³•

### åˆå§‹åŒ–æ•°æ®åº“

é¦–æ¬¡ä½¿ç”¨å¿…é¡»å…ˆå…¨é‡å¯¼å…¥å†å²æ•°æ®ï¼Œå¯ä»¥ä» [é€šè¾¾ä¿¡åˆ¸å•†æ•°æ®](https://www.tdx.com.cn/article/vipdata.html) ä¸‹è½½**æ²ªæ·±äº¬æ—¥çº¿æ•°æ®å®Œæ•´åŒ…**ä½¿ç”¨ï¼š

```bash
# ä»¥ä¸‹å‘½ä»¤åœ¨ç»ˆç«¯æ‰§è¡Œ

wget https://data.tdx.com.cn/vipdoc/hsjday.zip  # æ²ªæ·±äº¬æ—¥çº¿æ•°æ®å®Œæ•´åŒ…ï¼Œå¯ä»¥ä½¿ç”¨æµè§ˆå™¨ä¸‹è½½

mkdir vipdoc
unzip -q hsjday.zip -d vipdoc

# äºŒè¿›åˆ¶å®‰è£…è¿è¡Œ
tdx2db init --dbpath tdx.db --dayfiledir vipdoc

# é€šè¿‡ docker è¿è¡Œï¼Œè¿è¡Œç»“æŸå tdx.db ä¼šåœ¨å½“å‰å·¥ä½œç›®å½•ï¼Œå’Œ vipdoc ç›®å½•åœ¨åŒä¸€çº§
docker run --rm --platform=linux/amd64 -v "$(pwd)":/data ghcr.io/jing2uo/tdx2db:latest init --dayfiledir /data/vipdoc --dbpath /data/tdx.db

# ç¤ºä¾‹è¾“å‡º
ğŸ›  å¼€å§‹è½¬æ¢ dayfiles ä¸º CSV
ğŸ”¥ è½¬æ¢å®Œæˆ
ğŸ“Š è‚¡ç¥¨æ•°æ®å¯¼å…¥æˆåŠŸ
âœ… å¤„ç†å®Œæˆï¼Œè€—æ—¶ 5.007506252s

# rm -r hsjday.zip vipdoc  # åˆå§‹åŒ–åå¯ä»¥åˆ é™¤
```

**å¿…å¡«å‚æ•°**ï¼š

- `--dayfiledir`ï¼šé€šè¾¾ä¿¡ .day æ–‡ä»¶æ‰€åœ¨ç›®å½•è·¯å¾„
- `--dbpath`ï¼šDuckDB æ•°æ®åº“æ–‡ä»¶è·¯å¾„

### å¢é‡æ›´æ–°

cron å‘½ä»¤ä¼šæ›´æ–°æ•°æ®åº“è‡³æœ€æ–°æ—¥æœŸï¼ŒåŒ…æ‹¬è‚¡ç¥¨æ•°æ®ã€è‚¡æœ¬å˜è¿æ•°æ® (gbbq)ï¼Œå¹¶è®¡ç®—å‰æ”¶ç›˜ä»·å’Œå¤æƒå› å­ã€‚

åˆæ¬¡ä½¿ç”¨æ—¶ï¼Œè¯·åœ¨ init åç«‹åˆ»æ‰§è¡Œä¸€æ¬¡ cronï¼Œä»¥è·å¾—å¤æƒç›¸å…³æ•°æ®ã€‚

```bash
# äºŒè¿›åˆ¶å®‰è£…è¿è¡Œ
tdx2db cron --dbpath tdx.db

# é€šè¿‡ docker è¿è¡Œ
docker run --rm --platform=linux/amd64 -v "$(pwd)":/data ghcr.io/jing2uo/tdx2db:latest cron --dbpath /data/tdx.db

# ç¤ºä¾‹è¾“å‡º
ğŸ“… æ—¥çº¿æ•°æ®çš„æœ€æ–°æ—¥æœŸä¸º 2025-10-23
ğŸ›  å¼€å§‹ä¸‹è½½æ—¥çº¿æ•°æ®
âœ… å·²ä¸‹è½½ 20251024 çš„æ•°æ®
ğŸŸ¡ 20251025 éäº¤æ˜“æ—¥æˆ–æ•°æ®å°šæœªæ›´æ–°
ğŸ›  å¼€å§‹è½¬æ¢ dayfiles ä¸º CSV
ğŸ”¥ è½¬æ¢å®Œæˆ
ğŸ“Š è‚¡ç¥¨æ•°æ®å¯¼å…¥æˆåŠŸ
ğŸ›  å¼€å§‹ä¸‹è½½é™¤æƒé™¤æ¯æ•°æ®
ğŸ“ˆ é™¤æƒé™¤æ¯æ•°æ®æ›´æ–°æˆåŠŸ
ğŸ“Ÿ è®¡ç®—æ‰€æœ‰è‚¡ç¥¨å‰æ”¶ç›˜ä»·
ğŸ”¢ å¤æƒå› å­å¯¼å…¥æˆåŠŸ
ğŸ”„ åˆ›å»º/æ›´æ–°å‰å¤æƒæ•°æ®è§†å›¾ (v_qfq_stocks)
âœ… å¤„ç†å®Œæˆï¼Œè€—æ—¶ 22.805808029s
```

**å¿…å¡«å‚æ•°**ï¼š

- `--dbpath`ï¼šDuckDB æ•°æ®åº“æ–‡ä»¶è·¯å¾„ï¼ˆä½¿ç”¨ init æ—¶åˆ›å»ºçš„æ–‡ä»¶ï¼Œdb æ–‡ä»¶å¯ä»¥ç§»åŠ¨ï¼Œé€šè¿‡è·¯å¾„èƒ½æ‰¾åˆ°å³å¯ï¼‰

### å‰å¤æƒä»·æŸ¥è¯¢

**v_qfq_stocks** è§†å›¾ä¿å­˜äº†å‰å¤æƒæ•°æ®ï¼Œæ‰§è¡Œ factor å’Œ cron å­å‘½ä»¤æ—¶è§†å›¾ä¼šè‡ªåŠ¨æ›´æ–°ï¼š

```sql
select * from v_qfq_stocks where symbol='sz000001' order by date;
```

**raw_adjust_factor** è¡¨ä¸­ä¿å­˜äº†å‰æ”¶ç›˜ä»·å’Œå‰å¤æƒå› å­ï¼Œå¯ä»¥æ ¹æ®å‰æ”¶ç›˜ä»·æ‹“å±•å…¶ä»–å¤æƒç®—æ³•ï¼š

```sql
select * from raw_adjust_factor where symbol='sz000001';
```

å¤æƒåŸç†å‚è€ƒï¼š[ç‚¹å‡»æŸ¥çœ‹](https://www.yuque.com/zhoujiping/programming/eb17548458c94bc7c14310f5b38cf25c#djL6L) , ç®—æ³•æ¥è‡ª QUANTAXISï¼Œå¤æƒç»“æœå’Œé›ªçƒã€æ–°æµªä¸¤å®¶ç»“æœä¸€è‡´ï¼Œå’ŒåŒèŠ±é¡ºåŠå¸¸è§åˆ¸å•†çš„ç»“æœä¸ä¸€è‡´ã€‚

### è¡¨ç®€ä»‹

raw\_ å‰ç¼€çš„è¡¨åç”¨äºå­˜å‚¨åŸºç¡€æ•°æ®ï¼Œv\_ å‰ç¼€çš„è¡¨åæ˜¯è§†å›¾

- raw_adjust_factor: å‰æ”¶ç›˜ä»·å’Œå‰å¤æƒå› å­
- raw_gbbqï¼šè‚¡æœ¬å˜è¿ï¼ˆé™¤æƒé™¤æ¯ï¼‰æ•°æ®
- raw_stocks_dailyï¼š è‚¡ç¥¨æ—¥çº¿æ•°æ®
- v_qfq_stocksï¼šå‰å¤æƒè‚¡ç¥¨æ•°æ®

é¡¹ç›®ä¸‹ sql ç›®å½•ä¸­ä¿å­˜äº†ä¸€äº› sqlï¼Œå¯ç”¨äºåˆ›å»ºåŸºæœ¬çš„æŠ€æœ¯æŒ‡æ ‡è§†å›¾ã€‚

## è‡ªåŠ¨è¿è¡Œ

Linux ä¸‹é€šè¿‡ cron å®ç°æ¯æ—¥ 17:00 è‡ªåŠ¨æ›´æ–°ï¼š

1. ç¼–è¾‘å®šæ—¶ä»»åŠ¡ï¼š

```bash
crontab -e
```

2. æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼ˆè¯·æ›¿æ¢å®é™…è·¯å¾„ï¼‰ï¼š

```shell
# æ›´æ–°è‚¡ç¥¨å’Œè‚¡æœ¬å˜è¿æ•°æ®ï¼Œè®¡ç®—å‰æ”¶ç›˜ä»·å’Œå¤æƒå› å­
00 17 * * * tdx2db cron --dbpath /æ•°æ®åº“è·¯å¾„/æ•°æ®åº“å.db >> /æ—¥å¿—è·¯å¾„/tdx2db.log 2>&1
```

**æ³¨æ„äº‹é¡¹**ï¼š

- é€šè¾¾ä¿¡æ¯æ—¥æ•°æ®ä¸æ˜¯æ”¶ç›˜åç«‹å³æ›´æ–°ï¼Œä¸‹åˆ 5 ç‚¹åæ˜¯åˆé€‚çš„æ—¶é—´
- ç¡®ä¿æ—¥å¿—æ–‡ä»¶æœ‰å†™å…¥æƒé™

## å¤‡ä»½

1. å¯ä»¥ç›´æ¥å¤åˆ¶ä¸€ä»½ db æ–‡ä»¶ï¼Œç®€å•å¿«æ·
2. å¯ä»¥ç”¨ duckdb å‘½ä»¤å¯¼å‡ºè¡Œæƒ…æ•°æ®ä¸º parquet

duckdb å‘½ä»¤ä½¿ç”¨ï¼š

```bash
# å¯¼å‡º stocks è¡¨ä¸­æ‰€æœ‰æ•°æ®åˆ° stocks.parquet
duckdb tdx.db -s "COPY (SELECT * FROM raw_stocks_daily) TO 'stocks.parquet' (FORMAT PARQUET, COMPRESSION 'ZSTD')"

duckdb tdx.db # æ­¤å¤„ç›´æ¥å›è½¦è¿›å…¥ duckdb çš„äº¤äº’ç»ˆç«¯

# ä» stocks.parquet é‡æ–°å»ºè¡¨
create table raw_stocks_daily as select * from read_parquet('stocks.parquet');

# CTRL+D é€€å‡º duckdb
```

## TODO

- [ ] å¯¼å…¥åˆ° clickhouseã€questdb ç­‰æ•°æ®åº“

## æ¬¢è¿ issue å’Œ pr

æœ‰ä»»ä½•ä½¿ç”¨é—®é¢˜éƒ½å¯ä»¥å¼€ issue è®¨è®ºï¼Œä¹ŸæœŸå¾… pr~

---
